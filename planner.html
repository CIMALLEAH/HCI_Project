<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PlanEase - Planner</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="app-container">
    <!-- Header -->
    <div class="header">
      <div class="logo">
        <div class="logo-img"><img src="assets/logo.png" alt="PlanEase Logo"></div>
        <div class="logo-text">
          <h1>PLAN EASE</h1>
          <p>Plan with Ease</p>
        </div>
      </div>

      <div class="header-right">
        <div class="notification-btn" id="notifBtn" title="Notifications">
          <i class="fas fa-list"></i>
          <div class="notification-dot"></div>
        </div>
        <div class="profile-icon" id="profileIcon">
          <img src="assets/profile_pic.png" alt="Profile">
          <div class="profile-tooltip">
            <div class="profile-tooltip-name">Damian Alvah</div>
            <div class="profile-tooltip-email">dalvah@gmail.com</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Notification panel -->
    <div class="notification-panel" id="notificationPanel">
      <h3><i class="fas fa-list"></i> Today & Upcoming</h3>
      <div id="notificationList"><!-- JS fills --></div>
    </div>

    <!-- Content -->
    <div class="content">
      <div class="planner-header">
        <h1>Planner</h1>
        <div style="display:flex;gap:10px">
          <button class="add-btn" id="openAdd">
            <i class="fa-solid fa-calendar-days fa-calendar-alt"></i>
            <i class="fas fa-plus"></i>
            <span>Add</span>
          </button>
          <button class="add-btn" id="importBtn" title="Import semester schedule">
            <i class="fas fa-upload"></i>
            <span>Import</span>
          </button>
        </div>
      </div>

      <div class="planner-filters">
        <select class="filter-dropdown" id="filterSelect">
          <optgroup label="All Items">
            <option value="all" selected>All</option>
            <option value="all-tasks">All Tasks</option>
            <option value="all-events">All Events</option>
          </optgroup>
          <optgroup label="Current">
            <option value="current">Current</option>
            <option value="current-tasks">Current Tasks</option>
            <option value="current-events">Current Events</option>
          </optgroup>
          <optgroup label="Missed">
            <option value="missed">Missed</option>
            <option value="missed-tasks">Missed Tasks</option>
            <option value="missed-events">Missed Events</option>
          </optgroup>
          <optgroup label="Completed">
            <option value="completed">Completed</option>
            <option value="completed-tasks">Completed Tasks</option>
            <option value="completed-events">Completed Events</option>
          </optgroup>
        </select>
      </div>

      <div class="planner-list" id="plannerList">
        <!-- populated by JS -->
      </div>
    </div>

    <!-- bottom nav -->
    <div class="bottom-nav">
      <a href="home.html" class="nav-item"><div class="nav-icon"><i class="fas fa-home"></i></div><div>Home</div></a>
      <a href="calendar.html" class="nav-item"><div class="nav-icon"><i class="far fa-calendar-alt"></i></div><div>Calendar</div></a>
      <a href="planner.html" class="nav-item active"><div class="nav-icon"><i class="fas fa-book"></i></div><div>Planner</div></a>
      <a href="account.html" class="nav-item"><div class="nav-icon"><i class="far fa-user"></i></div><div>Account</div></a>
    </div>
  </div>

  <!-- Hidden file input for import -->
  <input type="file" id="importFile" accept=".json,.csv" style="display:none">

  <!-- Import modal -->
  <div class="modal" id="importModal">
    <div class="modal-content">
      <div style="font-size:36px;color:#4a9eff;margin-bottom:8px"><i class="fas fa-upload"></i></div>
      <h2 style="margin-bottom:14px;font-size:20px">Import Schedule</h2>
      <div style="margin-bottom:14px;font-size:14px;opacity:0.9">
        <p style="margin-bottom:10px">Upload a JSON or CSV file with your semester schedule.</p>
        <p style="font-size:12px;opacity:0.7;margin-bottom:10px"><strong>JSON Format:</strong></p>
        <code style="background:rgba(0,0,0,0.3);padding:8px;border-radius:4px;display:block;font-size:11px;margin-bottom:10px;overflow-x:auto">[{"title":"IT 321","fullTitle":"HCI","category":"school","kind":"event","startDate":"2025-12-06","startTime":"10:00","endDate":"2025-12-06","endTime":"13:30","location":"Online"}]</code>
        <p style="font-size:12px;opacity:0.7"><strong>CSV Format:</strong> title,fullTitle,category,kind,startDate,startTime,endDate,endTime,location</p>
      </div>
      <div style="display:flex;gap:8px;justify-content:center">
        <button class="btn ghost" id="cancelImport">Cancel</button>
        <button class="btn primary" id="selectImportFile">Choose File</button>
      </div>
    </div>
  </div>
  <div class="modal" id="deleteModal">
    <div class="modal-content">
      <div style="font-size:36px;color:#ff6b6b;margin-bottom:8px"><i class="fas fa-exclamation-triangle"></i></div>
      <div style="margin-bottom:14px">Are you sure you want to delete this item? This cannot be undone.</div>
      <div style="display:flex;gap:8px;justify-content:center">
        <button class="btn ghost" id="cancelDelete">Cancel</button>
        <button class="btn primary" id="confirmDelete">Delete</button>
      </div>
    </div>
  </div>

  <!-- Add/Edit overlay -->
  <div class="overlay" id="overlay">
    <div class="overlay-panel" role="dialog" aria-modal="true">
      <div class="overlay-header">
        <h2 id="overlayTitle">Add item</h2>
        <button class="close-overlay" id="closeOverlay" title="Close"><i class="fas fa-times"></i></button>
      </div>

      <form id="itemForm" class="form-grid">
        <div>
          <label>Type</label>
          <div style="display:flex;gap:8px;margin-bottom:10px">
            <button type="button" class="btnType btn ghost" data-type="event">Event</button>
            <button type="button" class="btnType btn ghost" data-type="task">Task</button>
          </div>

          <label for="title">Title <span class="small" style="opacity:.8"> (required)</span></label>
          <input id="title" name="title" type="text" required placeholder="e.g. IT 321 - HCI" />

          <label for="description">Description</label>
          <textarea id="description" name="description" placeholder="Add a subtle description (optional)"></textarea>

          <label for="category">Category / Tag</label>
          <select id="category" name="category">
            <option value="school">School</option>
            <option value="work">Work</option>
            <option value="personal">Personal</option>
          </select>

          <label for="priority" id="priorityLabel">Priority (Tasks only)</label>
          <select id="priority" name="priority">
            <option value="low">Low</option>
            <option value="medium" selected>Medium</option>
            <option value="high">High</option>
            <option value="urgent">Urgent</option>
          </select>

          <label style="margin-top:8px">Reminders / Alarms</label>
          <select id="reminder">
            <option value="none">No reminder</option>
            <option value="at_time">At time</option>
            <option value="5m">5 minutes before</option>
            <option value="10m">10 minutes before</option>
            <option value="30m">30 minutes before</option>
            <option value="1h">1 hour before</option>
            <option value="1d">1 day before</option>
          </select>

          <label style="margin-top:8px">Repeat</label>
          <select id="repeat">
            <option value="none">None</option>
            <option value="daily">Daily</option>
            <option value="weekly">Weekly</option>
            <option value="biweekly">Bi-weekly</option>
            <option value="monthly">Monthly</option>
          </select>

          <label style="margin-top:8px">Attachments (optional)</label>
          <input type="file" id="attachment" />

        </div>

        <aside>
          <label>Dates & Time</label>
          <div style="margin-bottom:8px">
            <label style="display:flex;gap:8px;align-items:center"><input type="checkbox" id="bulkToggle"> <span class="small">Create full semester schedule</span></label>
          </div>

          <div id="bulkOptions" style="display:none;border:1px solid rgba(255,255,255,0.04);padding:10px;border-radius:8px;margin-bottom:10px">
            <div style="margin-bottom:8px"><strong>Semester range</strong></div>
            <div class="row" style="margin-bottom:8px">
              <input type="date" id="semStart" />
              <input type="date" id="semEnd" />
            </div>

            <div style="margin-bottom:8px"><strong>Week template A (week 1)</strong></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:8px">
              <div>Mon: <select id="weekA_mon"><option value="none">None</option><option value="f2f">F2F</option><option value="online">Online</option></select></div>
              <div>Tue: <select id="weekA_tue"><option value="none">None</option><option value="f2f">F2F</option><option value="online">Online</option></select></div>
              <div>Wed: <select id="weekA_wed"><option value="none">None</option><option value="f2f">F2F</option><option value="online">Online</option></select></div>
              <div>Thu: <select id="weekA_thu"><option value="none">None</option><option value="f2f">F2F</option><option value="online">Online</option></select></div>
              <div>Fri: <select id="weekA_fri"><option value="none">None</option><option value="f2f">F2F</option><option value="online">Online</option></select></div>
            </div>

            <div style="margin-bottom:8px"><strong>Week template B (week 2)</strong></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
              <div>Mon: <select id="weekB_mon"><option value="none">None</option><option value="f2f">F2F</option><option value="online">Online</option></select></div>
              <div>Tue: <select id="weekB_tue"><option value="none">None</option><option value="f2f">F2F</option><option value="online">Online</option></select></div>
              <div>Wed: <select id="weekB_wed"><option value="none">None</option><option value="f2f">F2F</option><option value="online">Online</option></select></div>
              <div>Thu: <select id="weekB_thu"><option value="none">None</option><option value="f2f">F2F</option><option value="online">Online</option></select></div>
              <div>Fri: <select id="weekB_fri"><option value="none">None</option><option value="f2f">F2F</option><option value="online">Online</option></select></div>
            </div>
          </div>

          <div class="row">
            <input type="date" id="startDate" />
            <input type="time" id="startTime" />
          </div>
          <div class="row" style="margin-top:8px">
            <input type="date" id="endDate" />
            <input type="time" id="endTime" />
          </div>
          <div style="margin-top:8px">
            <label class="row"><input type="checkbox" id="allDay" /> <span class="small">All-day</span></label>
          </div>

          <label style="margin-top:10px">Delivery Mode</label>
          <select id="mode">
            <option value="online">Online</option>
            <option value="f2f">Face-to-Face (F2F)</option>
            <option value="hybrid">Hybrid</option>
          </select>

          <div id="modeFields" style="margin-top:8px"></div>

          <div style="margin-top:14px;display:flex;gap:8px;align-items:center">
            <label class="small">Mark as completed</label>
            <input type="checkbox" id="completedFlag" />
          </div>

          <div class="form-actions" style="margin-top:20px">
            <button type="button" class="btn ghost" id="cancelForm">Cancel</button>
            <button type="submit" class="btn primary" id="saveForm">Save</button>
          </div>
        </aside>
      </form>
    </div>
  </div>

<script>
/* =========================
   Hardcoded initial data
   ========================= */
let events = [
  {
    id: 1,
    kind: 'event',
    category: 'school',
    type: 'school',
    title: 'IT 321',
    fullTitle: 'Human-Computer Interaction',
    location: 'Online',
    startDate: '2025-12-06',
    startTime: '10:00',
    endDate: '2025-12-06',
    endTime: '13:30',
    priority: 'medium',
    reminder: '10m',
    completed: false
  },
  {
    id: 2,
    kind: 'event',
    category: 'school',
    type: 'school',
    title: 'CS 311',
    fullTitle: 'Automata Theory and Formal Languages',
    location: 'Online',
    startDate: '2025-10-23',
    startTime: '07:00',
    endDate: '2025-10-23',
    endTime: '08:30',
    priority: 'medium',
    reminder: '30m',
    completed: false
  },
  {
    id: 3,
    kind: 'event',
    category: 'school',
    type: 'school',
    title: 'GEd 104',
    fullTitle: 'The Contemporary World',
    location: 'Online',
    startDate: '2025-10-23',
    startTime: '07:00',
    endDate: '2025-10-23',
    endTime: '08:30',
    priority: 'medium',
    reminder: '30m',
    completed: false
  },
  {
    id: 4,
    kind: 'event',
    category: 'school',
    type: 'school',
    title: 'IT 314',
    fullTitle: 'Web Systems and Technologies',
    location: 'Online',
    startDate: '2025-10-23',
    startTime: '13:00',
    endDate: '2025-10-23',
    endTime: '16:00',
    priority: 'medium',
    reminder: '30m',
    completed: false
  },
  {
    id: 5,
    kind: 'event',
    category: 'school',
    type: 'school',
    title: 'IT 331',
    fullTitle: 'Application Development and Emerging Technologies',
    location: 'Online',
    startDate: '2025-10-24',
    startTime: '07:00',
    endDate: '2025-10-24',
    endTime: '10:00',
    priority: 'medium',
    reminder: '30m',
    completed: false
  },
  {
    id: 6,
    kind: 'event',
    category: 'school',
    type: 'school',
    title: 'CS 312',
    fullTitle: 'Mobile Computing',
    location: 'Online',
    startDate: '2025-10-24',
    startTime: '07:00',
    endDate: '2025-10-24',
    endTime: '08:30',
    priority: 'medium',
    reminder: '30m',
    completed: false
  },
  {
    id: 7,
    kind: 'event',
    category: 'personal',
    type: 'personal',
    title: 'Dental Appointment',
    fullTitle: 'Dental Appointment',
    location: 'Dental Clinic',
    startDate: '2025-10-24',
    startTime: '14:00',
    endDate: '2025-10-24',
    endTime: '15:00',
    priority: 'low',
    reminder: '1d',
    completed: false
  },
  {
    id: 8,
    kind: 'task',
    category: 'school',
    type: 'school',
    title: 'Submit IT 321 report',
    fullTitle: 'Submit final report for HCI',
    location: 'Online',
    startDate: '2025-12-05',
    startTime: '23:59',
    endDate: '2025-12-05',
    endTime: '23:59',
    priority: 'high',
    reminder: '1d',
    completed: false
  },
  {
    id: 9,
    kind: 'task',
    category: 'personal',
    type: 'personal',
    title: 'Buy groceries',
    fullTitle: 'Groceries: milk, eggs, bread',
    location: 'Grocery Store',
    startDate: '2025-12-07',
    startTime: '10:00',
    endDate: '2025-12-07',
    endTime: '11:00',
    priority: 'low',
    reminder: 'none',
    completed: true
  },
  {
    id: 10,
    kind: 'event',
    category: 'work',
    type: 'work',
    title: 'Team Meeting',
    fullTitle: 'Weekly sync meeting',
    location: 'Office',
    startDate: '2025-12-08',
    startTime: '10:00',
    endDate: '2025-12-08',
    endTime: '11:00',
    priority: 'high',
    reminder: '30m',
    completed: false
  }
];

/* =========================
   App state
   ========================= */
let state = {
  filter: 'all',
  sort: 'date',
  editingId: null
}

/* =========================
   DOM helpers & render
   ========================= */

const plannerList = document.getElementById('plannerList');
const notificationPanel = document.getElementById('notificationPanel');
const notificationList = document.getElementById('notificationList');
const overlay = document.getElementById('overlay');
const overlayTitle = document.getElementById('overlayTitle');
const itemForm = document.getElementById('itemForm');
const deleteModal = document.getElementById('deleteModal');

function getIconForCategory(category) {
  switch(category) {
    case 'school': return 'fa-graduation-cap';
    case 'work': return 'fa-briefcase';
    case 'personal': return 'fa-user';
    default: return 'fa-circle';
  }
}

function formatDate(dateStr){
  if(!dateStr) return '';
  const d = new Date(dateStr + 'T00:00');
  return d.toLocaleDateString('en-GB');
}

function daysUntil(dateStr){
  const today = new Date(); today.setHours(0,0,0,0);
  const d = new Date(dateStr + 'T00:00');
  const diff = Math.ceil((d - today)/(1000*60*60*24));
  return diff;
}

function getBadgeForEvent(e){
  const diffDays = daysUntil(e.startDate);
  if(e.kind === 'event' && diffDays <= 0 && diffDays >= -1){
    return {text: 'Ends soon', cls:'ending-soon'};
  } else if(diffDays === 0){
    return {text:'Today', cls:'ending-soon'};
  } else if(diffDays === 1){
    return {text:'Tomorrow', cls:'tomorrow'};
  } else if(diffDays > 1 && diffDays <=7){
    const dayNames = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
    const dayName = new Date(e.startDate).getDay();
    return {text: dayNames[dayName], cls: 'dayname'};
  } else {
    return {text: formatDate(e.startDate), cls:'dayname'};
  }
}

function renderTodayPanel(){
  const now = new Date();
  now.setHours(0,0,0,0);
  const in7days = new Date();
  in7days.setDate(now.getDate() + 7);

  const items = events.filter(ev=>{
    const start = new Date(ev.startDate + 'T00:00');
    const isToday = start.getTime() === now.getTime();
    const isOverdue = !ev.completed && start < now;
    const isUpcoming7 = start > now && start <= in7days;
    return isToday || isOverdue || isUpcoming7;
  }).sort((a,b)=> new Date(a.startDate + 'T' + (a.startTime||'00:00')) - new Date(b.startDate + 'T' + (b.startTime||'00:00')) );

  if(items.length === 0){
    notificationList.innerHTML = '<div class="notification-item">No tasks/events for today or upcoming.</div>';
    return;
  }

  notificationList.innerHTML = items.map((ev,i)=>{
    let badgeText='';
    let badgeClass='';
    const start = new Date(ev.startDate + 'T00:00');
    const diffDays = Math.ceil((start - now)/(1000*60*60*24));
    if(!ev.completed && start < now) {
      badgeText = 'Overdue';
      badgeClass = 'overdue';
    } else if(diffDays === 0) {
      badgeText = 'Today';
      badgeClass = 'today';
    } else if(diffDays === 1) {
      badgeText = 'Tomorrow';
      badgeClass = 'current';
    } else if(diffDays > 1 && diffDays <=7){
      const dayNames = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
      badgeText = dayNames[start.getDay()];
      badgeClass = 'current';
    }

    return `<div class="notification-item ${badgeClass}">
      <strong>${ev.title} ${badgeText ? '('+badgeText+')' : ''}</strong><br>
      <small>${ev.fullTitle || ''} • ${ev.startTime || '—'} - ${ev.endTime || '—'}</small>
    </div>`;
  }).join('');
}

function renderNotifications(){
  renderTodayPanel();
}

function renderPlanner(){
  let items = [...events];
  
  const now = new Date();
  now.setHours(0,0,0,0);
  
  if(state.filter === 'all'){
  } else if(state.filter === 'all-tasks'){
    items = items.filter(i => i.kind === 'task');
  } else if(state.filter === 'all-events'){
    items = items.filter(i => i.kind === 'event');
  } else if(state.filter === 'current'){
    items = items.filter(i => !i.completed);
  } else if(state.filter === 'current-tasks'){
    items = items.filter(i => !i.completed && i.kind === 'task');
  } else if(state.filter === 'current-events'){
    items = items.filter(i => !i.completed && i.kind === 'event');
  } else if(state.filter === 'missed'){
    items = items.filter(i => !i.completed && new Date(i.startDate + 'T00:00') < now);
  } else if(state.filter === 'missed-tasks'){
    items = items.filter(i => !i.completed && i.kind === 'task' && new Date(i.startDate + 'T00:00') < now);
  } else if(state.filter === 'missed-events'){
    items = items.filter(i => !i.completed && i.kind === 'event' && new Date(i.startDate + 'T00:00') < now);
  } else if(state.filter === 'completed'){
    items = items.filter(i => i.completed);
  } else if(state.filter === 'completed-tasks'){
    items = items.filter(i => i.completed && i.kind === 'task');
  } else if(state.filter === 'completed-events'){
    items = items.filter(i => i.completed && i.kind === 'event');
  }

  items.sort((a,b)=>{
    if(a.completed !== b.completed) return a.completed ? 1 : -1;
    const da = new Date((a.startDate||'1970-01-01') + 'T' + (a.startTime||'00:00'));
    const db = new Date((b.startDate||'1970-01-01') + 'T' + (b.startTime||'00:00'));
    return da - db;
  });

  const grouped = {};
  items.forEach(item => {
    const date = new Date(item.startDate + 'T00:00');
    const monthKey = date.toLocaleDateString('en-GB', {month: 'long', year: 'numeric'});
    if(!grouped[monthKey]) grouped[monthKey] = [];
    grouped[monthKey].push(item);
  });

  if(items.length === 0){
    plannerList.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:rgba(255,255,255,0.5)">No items found.</div>';
    return;
  }

  let html = '';
  Object.keys(grouped).forEach(monthKey => {
    html += `<div style="grid-column:1/-1;padding:12px 0;margin-top:10px;border-bottom:1px solid rgba(255,255,255,0.1);"><h2 style="font-size:16px;opacity:0.8">${monthKey}</h2></div>`;
    grouped[monthKey].forEach(ev => {
      const badge = getBadgeForEvent(ev);
      const indicatorColor = ev.category === 'personal' ? '#9b59b6' : ev.category === 'work' ? '#1d9a66' : '#4a9eff';
      const typeIcon = ev.kind === 'task' ? 'fa-list-check' : getIconForCategory(ev.category);
      const typeName = ev.kind === 'task' ? 'Task' : 'Event';
      const completedCls = ev.completed ? 'completed' : '';
      html += `<div class="event-item ${ev.category} ${completedCls}" data-id="${ev.id}">
        <div class="event-header">
          <div style="display:flex;gap:10px;align-items:center">
            <div class="event-indicator" style="background:${indicatorColor}"></div>
            <div>
              <h3 style="margin:0">${ev.title}</h3>
              <div class="muted small">${ev.fullTitle || ''}</div>
            </div>
          </div>
          <div style="text-align:right">
            <div class="event-badge ${badge.cls}" title="Date">${badge.text}</div>
          </div>
        </div>

        <div class="event-details">
          <p><i class="fas ${typeIcon}"></i> ${typeName} • <strong>${ev.category}</strong></p>
          <p><i class="fas fa-map-marker-alt"></i> ${ev.location || '—'}</p>
          <p class="event-time"><i class="far fa-calendar"></i> ${formatDate(ev.startDate)} <br><i class="far fa-clock"></i> ${ev.startTime || '—'} - ${ev.endTime || '—'}</p>
        </div>

        <div class="event-actions">
          <button class="action-btn edit" data-id="${ev.id}" title="Edit"><i class="fas fa-edit"></i> Edit</button>
          <button class="action-btn delete" data-id="${ev.id}" title="Delete"><i class="fas fa-trash"></i> Delete</button>
          <button class="action-btn" data-complete="${ev.id}" title="Toggle complete" style="background:rgba(255,255,255,0.03);color:#fff">
            <i class="fas ${ev.completed ? 'fa-check-circle' : 'fa-circle'}"></i> ${ev.completed ? 'Completed' : 'Mark'}
          </button>
        </div>
      </div>`;
    });
  });
  plannerList.innerHTML = html;

  document.querySelectorAll('.action-btn.edit').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      const id = Number(btn.dataset.id);
      openOverlay('edit', id);
    });
  });
  document.querySelectorAll('.action-btn.delete').forEach(btn=>{
    btn.addEventListener('click', ()=> {
      const id = Number(btn.dataset.id);
      openDeleteConfirm(id);
    });
  });
  document.querySelectorAll('.event-actions [data-complete]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = Number(btn.getAttribute('data-complete'));
      toggleComplete(id);
    });
  });
}

/* =========================
   CRUD-ish in-memory actions
   ========================= */
function nextId(){
  return Math.max(0,...events.map(e=>e.id)) + 1;
}

function addItem(payload){
  payload.id = nextId();
  events.push(payload);
  renderPlanner();
  renderNotifications();
}

function updateItem(id, payload){
  const idx = events.findIndex(e => e.id === id);
  if(idx !== -1){
    events[idx] = {...events[idx], ...payload};
    renderPlanner();
    renderNotifications();
  }
}

function deleteItem(id){
  events = events.filter(e => e.id !== id);
  closeDeleteConfirm();
  renderPlanner();
  renderNotifications();
}

function toggleComplete(id){
  const ev = events.find(e=>e.id===id);
  if(ev){
    ev.completed = !ev.completed;
    renderPlanner();
    renderNotifications();
  }
}

/* =========================
   Delete confirm modal
   ========================= */
let pendingDeleteId = null;
function openDeleteConfirm(id){
  pendingDeleteId = id;
  deleteModal.classList.add('active');
}
document.getElementById('cancelDelete').addEventListener('click', closeDeleteConfirm);
document.getElementById('confirmDelete').addEventListener('click', ()=>{ if(pendingDeleteId) deleteItem(pendingDeleteId); });
function closeDeleteConfirm(){ pendingDeleteId = null; deleteModal.classList.remove('active'); }

/* =========================
   Overlay (Add/Edit) behavior
   ========================= */
const openAddBtn = document.getElementById('openAdd');
const closeOverlayBtn = document.getElementById('closeOverlay');
const cancelFormBtn = document.getElementById('cancelForm');
const btnTypeEls = document.querySelectorAll('.btnType');

openAddBtn.addEventListener('click', ()=> openOverlay('add'));
closeOverlayBtn.addEventListener('click', closeOverlay);
cancelFormBtn.addEventListener('click', closeOverlay);

btnTypeEls.forEach(b=>{
  b.addEventListener('click', ()=>{
    btnTypeEls.forEach(x=>x.classList.remove('primary'));
    b.classList.add('primary');
    document.querySelectorAll('.btnType').forEach(btn=>btn.classList.remove('primary'));
    b.classList.add('primary');
    setFormKind(b.dataset.type);
  });
});

function openOverlay(mode='add', id=null){
  state.editingId = (mode==='edit'?id:null);
  overlay.classList.add('active');
  overlayTitle.textContent = mode === 'add' ? 'Add item' : 'Edit item';
  itemForm.reset();
  document.querySelectorAll('.btnType').forEach(bt=>bt.classList.remove('primary'));
  if(mode === 'add'){
    document.querySelector('.btnType[data-type="event"]').classList.add('primary');
    setFormKind('event');
    document.getElementById('priorityLabel').style.display = 'none';
    document.getElementById('priority').style.display = 'none';
    const bt = document.getElementById('bulkToggle'); if(bt) bt.checked = false;
    const bo = document.getElementById('bulkOptions'); if(bo) bo.style.display = 'none';
  } else {
    const ev = events.find(x=>x.id === id);
    if(!ev) return;
    const typeBtn = document.querySelector(`.btnType[data-type="${ev.kind}"]`);
    if(typeBtn) typeBtn.classList.add('primary');
    setFormKind(ev.kind);

    document.getElementById('title').value = ev.title || '';
    document.getElementById('description').value = ev.fullTitle || '';
    document.getElementById('category').value = ev.category || 'school';
    document.getElementById('priority').value = ev.priority || 'medium';
    document.getElementById('reminder').value = ev.reminder || 'none';
    document.getElementById('repeat').value = ev.repeat || 'none';
    document.getElementById('startDate').value = ev.startDate || '';
    document.getElementById('startTime').value = ev.startTime || '';
    document.getElementById('endDate').value = ev.endDate || '';
    document.getElementById('endTime').value = ev.endTime || '';
    document.getElementById('mode').value = ev.mode || 'online';
    document.getElementById('completedFlag').checked = !!ev.completed;
    renderModeFields();
  }
}

function closeOverlay(){
  overlay.classList.remove('active');
  state.editingId = null;
}

function setFormKind(kind){
  const priorityLabel = document.getElementById('priorityLabel');
  const priorityEl = document.getElementById('priority');
  if(kind === 'task'){
    priorityLabel.style.display = 'block';
    priorityEl.style.display = 'block';
  } else {
    priorityLabel.style.display = 'none';
    priorityEl.style.display = 'none';
  }
}

document.getElementById('mode').addEventListener('change', renderModeFields);
function renderModeFields(){
  const mode = document.getElementById('mode').value;
  const container = document.getElementById('modeFields');
  container.innerHTML = '';
  if(mode === 'f2f'){
    container.innerHTML = `
      <label>Address</label>
      <input type="text" id="f2fAddress" placeholder="Building / Room / Full address (optional)">
      <button type="button" class="btn ghost" style="margin-top:8px" id="useSavedLocations">Use saved locations</button>
    `;
  } else if(mode === 'online'){
    container.innerHTML = `
      <label>Online link</label>
      <input type="text" id="onlineLink" placeholder="Google Meet / Zoom / Teams URL">
      <label style="margin-top:8px">Meeting password (optional)</label>
      <input type="text" id="onlinePass" placeholder="Password / code (optional)">
    `;
  } else if(mode === 'hybrid'){
    container.innerHTML = `
      <label>Address</label>
      <input type="text" id="f2fAddress" placeholder="Building / Room / Full address">
      <label style="margin-top:8px">Online link</label>
      <input type="text" id="onlineLink" placeholder="Zoom / Meet link">
    `;
  }
}

itemForm.addEventListener('submit', function(e){
  e.preventDefault();
  const kind = document.querySelector('.btnType.primary')?.dataset.type || 'event';
  const title = document.getElementById('title').value.trim();
  if(!title){ alert('Title is required'); return; }

  const isBulk = document.getElementById('bulkToggle')?.checked;

  if(!isBulk){
    const payload = {
      kind: kind,
      title: title,
      fullTitle: document.getElementById('description').value.trim(),
      category: document.getElementById('category').value,
      type: document.getElementById('category').value,
      priority: document.getElementById('priority').value,
      reminder: document.getElementById('reminder').value,
      repeat: document.getElementById('repeat').value,
      startDate: document.getElementById('startDate').value || '',
      startTime: document.getElementById('startTime').value || '',
      endDate: document.getElementById('endDate').value || '',
      endTime: document.getElementById('endTime').value || '',
      mode: document.getElementById('mode').value || 'online',
      location: (document.getElementById('mode').value==='f2f') ? (document.getElementById('f2fAddress')?.value || '') : (document.getElementById('onlineLink')?.value || '') ,
      completed: document.getElementById('completedFlag').checked
    };

    if(state.editingId){
      updateItem(state.editingId, payload);
    } else {
      addItem(payload);
    }
    closeOverlay();
    return;
  }

  const semStartStr = document.getElementById('semStart')?.value;
  const semEndStr = document.getElementById('semEnd')?.value;
  if(!semStartStr || !semEndStr){ alert('Please provide semester start and end dates'); return; }
  const semStart = new Date(semStartStr + 'T00:00');
  const semEnd = new Date(semEndStr + 'T00:00');
  if(semEnd < semStart){ alert('Semester end must be after start'); return; }

  const days = ['mon','tue','wed','thu','fri'];
  const weekA = {};
  const weekB = {};
  days.forEach(d=>{
    weekA[d] = document.getElementById('weekA_'+d)?.value || 'none';
    weekB[d] = document.getElementById('weekB_'+d)?.value || 'none';
  });

  const base = {
    kind: kind,
    title: title,
    fullTitle: document.getElementById('description').value.trim(),
    category: document.getElementById('category').value,
    type: document.getElementById('category').value,
    priority: document.getElementById('priority').value,
    reminder: document.getElementById('reminder').value,
    repeat: document.getElementById('repeat').value,
    startTime: document.getElementById('startTime').value || '',
    endTime: document.getElementById('endTime').value || '',
    completed: document.getElementById('completedFlag').checked
  };

  const MAX_EVENTS = 500;
  let created = 0;

  const msPerDay = 24*60*60*1000;
  let cur = new Date(semStart.getTime());
  while(cur <= semEnd){
    const dow = cur.getDay();
    if(dow >= 1 && dow <=5){
      const weekOffset = Math.floor((cur - semStart) / (7*msPerDay));
      const template = (weekOffset % 2 === 0) ? weekA : weekB;
      const dayKey = days[dow-1];
      const modeForDay = template[dayKey];
      if(modeForDay && modeForDay !== 'none'){
        const payload = Object.assign({}, base);
        payload.startDate = cur.toISOString().slice(0,10);
        payload.endDate = payload.startDate;
        payload.mode = modeForDay;
        payload.location = (modeForDay === 'f2f') ? (document.getElementById('f2fAddress')?.value || '') : (document.getElementById('onlineLink')?.value || '');

        addItem(payload);
        created++;
        if(created >= MAX_EVENTS){
          alert('Reached maximum allowed events ('+MAX_EVENTS+'). Import stopped.');
          break;
        }
      }
    }
    cur = new Date(cur.getTime() + msPerDay);
  }

  alert('Created '+created+' events for the semester.');
  closeOverlay();
});

/* =========================
   Filters & UI wiring
   ========================= */
document.getElementById('filterSelect').addEventListener('change', function(e){
  state.filter = e.target.value;
  renderPlanner();
});

document.getElementById('notifBtn').addEventListener('click', ()=>{
  notificationPanel.classList.toggle('active');
});

document.addEventListener('click', (e)=>{
  const panel = document.getElementById('notificationPanel');
  const btn = document.getElementById('notifBtn');
  if(panel.classList.contains('active') && !panel.contains(e.target) && !btn.contains(e.target)){
    panel.classList.remove('active');
  }
});

document.getElementById('profileIcon').addEventListener('click', ()=>{
  window.location.href = 'account.html';
});

renderNotifications();
renderPlanner();
renderModeFields();

const bulkToggleEl = document.getElementById('bulkToggle');
if(bulkToggleEl){
  bulkToggleEl.addEventListener('change', (e)=>{
    const box = document.getElementById('bulkOptions');
    if(!box) return;
    box.style.display = e.target.checked ? 'block' : 'none';
  });
}

/* ========================= */
/* Import schedule functionality */
/* ========================= */
const importBtn = document.getElementById('importBtn');
const importFile = document.getElementById('importFile');
const importModal = document.getElementById('importModal');
const selectImportFileBtn = document.getElementById('selectImportFile');
const cancelImportBtn = document.getElementById('cancelImport');

importBtn.addEventListener('click', () => {
  importModal.classList.add('active');
});

selectImportFileBtn.addEventListener('click', () => {
  importFile.click();
});

cancelImportBtn.addEventListener('click', () => {
  importModal.classList.remove('active');
});

importFile.addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(event) {
    try {
      let data = [];
      
      if (file.name.endsWith('.json')) {
        data = JSON.parse(event.target.result);
      } else if (file.name.endsWith('.csv')) {
        data = parseCSV(event.target.result);
      }

      if (!Array.isArray(data) || data.length === 0) {
        alert('Invalid file format. Please provide a valid JSON or CSV file.');
        return;
      }

      let importedCount = 0;
      data.forEach(item => {
        if (item.title) {
          const payload = {
            kind: item.kind || 'event',
            title: item.title,
            fullTitle: item.fullTitle || '',
            category: item.category || 'school',
            type: item.type || item.category || 'school',
            priority: item.priority || 'medium',
            reminder: item.reminder || 'none',
            repeat: item.repeat || 'none',
            startDate: item.startDate || '',
            startTime: item.startTime || '',
            endDate: item.endDate || '',
            endTime: item.endTime || '',
            mode: item.mode || 'online',
            location: item.location || '',
            completed: item.completed || false
          };
          addItem(payload);
          importedCount++;
        }
      });

      alert(`Successfully imported ${importedCount} events!`);
      importModal.classList.remove('active');
      importFile.value = '';
    } catch (error) {
      alert('Error parsing file: ' + error.message);
    }
  };
  reader.readAsText(file);
});

function parseCSV(csvText) {
  const lines = csvText.trim().split('\n');
  if (lines.length < 2) return [];
  
  const headers = lines[0].split(',').map(h => h.trim());
  const data = [];
  
  for (let i = 1; i < lines.length; i++) {
    const values = lines[i].split(',').map(v => v.trim());
    const obj = {};
    headers.forEach((header, idx) => {
      obj[header] = values[idx] || '';
    });
    data.push(obj);
  }
  
  return data;
}

window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeOverlay(); });

</script>
</body>
</html>